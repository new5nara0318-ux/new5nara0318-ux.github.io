<?php
/*
Plugin Name: CPAP Research - Coupang Partners Demo
Description: 연구/테스트용 예시 플러그인 — 쿠팡파트너스 API 형태 데이터로 자동 포스트(샘플). 쿠팡파트너스 고지문구 포함. (연구용)
Version: 1.0
Author: ChatGPT (Research Example)
Text Domain: cpap-research
*/

if ( ! defined( 'ABSPATH' ) ) exit;

/* ---- 1) 커스텀 포스트 타입 등록 ---- */
function cpap_research_register_cpt() {
    $labels = array(
        'name' => 'CPAP Products',
        'singular_name' => 'CPAP Product',
    );
    $args = array(
        'labels' => $labels,
        'public' => true,
        'has_archive' => true,
        'supports' => array('title','editor','thumbnail'),
        'show_in_rest' => true,
        'menu_icon' => 'dashicons-products',
    );
    register_post_type('cpap_product', $args);
}
add_action('init','cpap_research_register_cpt');

/* ---- 2) 관리자 설정 페이지 (API 키 입력) ---- */
function cpap_research_admin_menu(){
    add_menu_page('CPAP Research','CPAP Research','manage_options','cpap-research','cpap_research_settings_page','dashicons-admin-generic', 60);
}
add_action('admin_menu','cpap_research_admin_menu');

function cpap_research_register_settings() {
    register_setting('cpap_research_options','cpap_research_access_key');
    register_setting('cpap_research_options','cpap_research_secret_key');
    register_setting('cpap_research_options','cpap_research_advertiser_id');
    register_setting('cpap_research_options','cpap_research_keyword');
    register_setting('cpap_research_options','cpap_research_limit');
    register_setting('cpap_research_options','cpap_research_show_disclosure');
}
add_action('admin_init','cpap_research_register_settings');

function cpap_research_settings_page() {
    if ( ! current_user_can('manage_options') ) return;
    // 수동 동기화 처리
    if ( isset($_POST['cpap_research_manual_sync']) && check_admin_referer('cpap_research_sync','cpap_research_nonce') ) {
        cpap_research_fetch_and_post();
        echo '<div class="updated"><p>Manual sync completed.</p></div>';
    }
    ?>
    <div class="wrap">
        <h1>CPAP Research Settings</h1>
        <form method="post" action="options.php">
            <?php settings_fields('cpap_research_options'); do_settings_sections('cpap_research_options'); ?>
            <table class="form-table">
                <tr>
                    <th>Access Key</th>
                    <td><input type="text" name="cpap_research_access_key" value="<?php echo esc_attr(get_option('cpap_research_access_key','')); ?>" style="width:420px;"></td>
                </tr>
                <tr>
                    <th>Secret Key</th>
                    <td><input type="text" name="cpap_research_secret_key" value="<?php echo esc_attr(get_option('cpap_research_secret_key','')); ?>" style="width:420px;"></td>
                </tr>
                <tr>
                    <th>Advertiser ID</th>
                    <td><input type="text" name="cpap_research_advertiser_id" value="<?php echo esc_attr(get_option('cpap_research_advertiser_id','')); ?>" style="width:420px;"></td>
                </tr>
                <tr>
                    <th>검색 키워드</th>
                    <td><input type="text" name="cpap_research_keyword" value="<?php echo esc_attr(get_option('cpap_research_keyword','인기상품')); ?>" style="width:420px;"></td>
                </tr>
                <tr>
                    <th>가져올 개수 (1~100)</th>
                    <td><input type="number" name="cpap_research_limit" value="<?php echo esc_attr(get_option('cpap_research_limit',100)); ?>" min="1" max="100"></td>
                </tr>
                <tr>
                    <th>쿠팡파트너스 고지문구 보이기</th>
                    <td><input type="checkbox" name="cpap_research_show_disclosure" value="1" <?php checked(1, get_option('cpap_research_show_disclosure',1)); ?>> 체크시 갤러리 하단에 고지문구 표시</td>
                </tr>
            </table>
            <?php submit_button(); ?>
        </form>

        <h2>Manual Sync</h2>
        <form method="post">
            <?php wp_nonce_field('cpap_research_sync','cpap_research_nonce'); ?>
            <input type="submit" name="cpap_research_manual_sync" class="button button-primary" value="Manual Sync Now">
        </form>

        <h2>주의 (연구·테스트)</h2>
        <ul>
            <li>이 코드는 연구/테스트 목적의 예시 코드입니다. 실제 서비스 운영 전 약관/법적 요구사항을 검토하세요.</li>
            <li>쿠팡 API 사용 시 응답 형식이나 인증 방식이 달라질 수 있으니, 공식 문서에 따라 필요한 서명을 추가하세요.</li>
        </ul>
    </div>
    <?php
}

/* ---- 3) 쿠팡 API 호출 (예시, 연구용) ----
   실제 운영시에는 쿠팡 공식 문서의 서명/인증 방식 따라야 함
-------------------------------------------*/
function cpap_research_call_api($keyword, $limit=20) {
    $access = trim(get_option('cpap_research_access_key',''));
    $secret = trim(get_option('cpap_research_secret_key',''));
    if ( empty($access) || empty($secret) ) return array();

    $endpoint = 'https://api-gateway.coupang.com/v2/providers/affiliate_open_api/apis/openapi/v1/products/search';
    $query = array(
        'keyword' => $keyword,
        'limit' => intval($limit),
        'sort' => 'HIGH_PRICE'
    );
    $url = $endpoint . '?' . http_build_query($query);

    // 간단 예시 헤더 (연구용)
    $headers = array(
        'Authorization' => 'CEA algorithm=HmacSHA256, access-key=' . $access,
        'Content-Type' => 'application/json;charset=UTF-8'
    );

    $resp = wp_remote_get($url, array('headers'=>$headers,'timeout'=>20));
    if ( is_wp_error($resp) ) return array();
    $body = wp_remote_retrieve_body($resp);
    $data = json_decode($body, true);
    if ( ! is_array($data) ) return array();

    // API 응답 구조에 따라 아래 반환을 조정하세요.
    if ( isset($data['data']) && is_array($data['data']) ) return $data['data'];
    if ( isset($data['products']) && is_array($data['products']) ) return $data['products'];
    if ( isset($data[0]) ) return $data;
    return array();
}

/* ---- 4) 간단한 카테고리/태그 매핑 (연구용) ---- */
function cpap_research_map_ctags($title) {
    $title_l = mb_strtolower($title);
    $cats = array();
    $tags = array();

    $rules = array(
        '전자제품' => array('노트북','컴퓨터','헤드폰','카메라','모니터','휴대폰','가전','TV'),
        '패션' => array('운동화','신발','티셔츠','자켓','코트','청바지'),
        '생활용품' => array('청소기','주방','냄비','프라이팬','정수기','매트'),
    );

    foreach($rules as $cat => $kwlist) {
        foreach($kwlist as $kw) {
            if ( mb_strpos($title_l, mb_strtolower($kw)) !== false ) {
                $cats[] = $cat;
                $tags[] = $kw;
            }
        }
    }

    if ( empty($cats) ) $cats[] = '기타';
    $cats = array_values(array_unique($cats));
    $tags = array_values(array_unique($tags));
    return array('categories'=>$cats,'tags'=>$tags);
}

/* ---- 5) 응답으로부터 포스트 생성 (연구용, 간단 처리) ---- */
function cpap_research_fetch_and_post() {
    $keyword = get_option('cpap_research_keyword','인기상품');
    $limit = intval(get_option('cpap_research_limit',20));
    if ( $limit < 1 ) $limit = 1;
    if ( $limit > 100 ) $limit = 100;

    $items = cpap_research_call_api($keyword, $limit);
    if ( empty($items) ) return;

    foreach($items as $item) {
        // 응답 필드명은 API에 따라 다름 — 연구용으로 여러 케이스 지원
        $title = isset($item['productName']) ? $item['productName'] : (isset($item['title']) ? $item['title'] : '');
        $price = isset($item['price']) ? intval($item['price']) : (isset($item['originalPrice']) ? intval($item['originalPrice']) : 0);
        $image = isset($item['productImage']) ? $item['productImage'] : (isset($item['image']) ? $item['image'] : '');
        $link = isset($item['affiliateUrl']) ? $item['affiliateUrl'] : (isset($item['link']) ? $item['link'] : '');

        if ( empty($title) || empty($link) ) continue;

        // 중복 체크 (같은 affiliate link가 있으면 건너뜀)
        $exists = get_posts(array(
            'post_type'=>'cpap_product',
            'meta_query'=>array(array('key'=>'cpap_research_affiliate','value'=>$link)),
            'posts_per_page'=>1,
        ));
        if ( $exists ) continue;

        $map = cpap_research_map_ctags($title);
        $cat_ids = array();
        foreach($map['categories'] as $cname) {
            $term = term_exists($cname,'category');
            if ( !$term ) {
                $new = wp_insert_term($cname,'category');
                if ( ! is_wp_error($new) ) $term_id = $new['term_id'];
                else $term_id = 0;
            } else {
                $term_id = is_array($term) ? $term['term_id'] : $term;
            }
            if ( $term_id ) $cat_ids[] = $term_id;
        }

        $content = '<p>가격: ' . number_format($price) . '원</p>';
        $content .= '<p><a class="cpap_research_button" href="'.esc_url($link).'" target="_blank" rel="nofollow noopener">구매 링크 (쿠팡)</a></p>';
        // 고지문구는 별도로 쇼트코드/갤러리에서 출력함

        $post_id = wp_insert_post(array(
            'post_type'=>'cpap_product',
            'post_title'=>wp_strip_all_tags($title),
            'post_content'=>$content,
            'post_status'=>'publish',
            'post_category'=>$cat_ids,
            'tags_input'=>$map['tags'],
        ));
        if ( ! $post_id || is_wp_error($post_id) ) continue;

        // 이미지 사이드로딩 (연구용 간단 방식)
        if ( ! empty($image) ) {
            require_once( ABSPATH.'wp-admin/includes/media.php' );
            require_once( ABSPATH.'wp-admin/includes/file.php' );
            require_once( ABSPATH.'wp-admin/includes/image.php' );
            @media_sideload_image( esc_url_raw($image), $post_id, $title );
            // 가장 최근 첨부파일을 대표 이미지로 설정 (간단 방법)
            $att = get_posts(array('post_type'=>'attachment','post_parent'=>$post_id,'posts_per_page'=>1,'orderby'=>'ID','order'=>'DESC'));
            if ( isset($att[0]->ID) ) set_post_thumbnail($post_id, $att[0]->ID);
        }

        update_post_meta($post_id,'cpap_research_price',$price);
        update_post_meta($post_id,'cpap_research_affiliate',$link);
    }
}

/* ---- 6) 예약 스케줄 (일일 실행) ---- */
function cpap_research_activate() {
    if ( ! wp_next_scheduled('cpap_research_daily') ) {
        wp_schedule_event(time(),'daily','cpap_research_daily');
    }
}
register_activation_hook(__FILE__,'cpap_research_activate');

function cpap_research_deactivate() {
    wp_clear_scheduled_hook('cpap_research_daily');
}
register_deactivation_hook(__FILE__,'cpap_research_deactivate');

add_action('cpap_research_daily','cpap_research_fetch_and_post');

/* ---- 7) 갤러리 쇼트코드 + 고지문구 ----
   사용: [cpap_research_gallery count="20"]
--------------------------------------------*/
function cpap_research_gallery_shortcode($atts) {
    $a = shortcode_atts(array('count'=>20), $atts);
    $args = array(
        'post_type'=>'cpap_product',
        'posts_per_page'=>intval($a['count']),
        'meta_key'=>'cpap_research_price',
        'orderby'=>'meta_value_num',
        'order'=>'DESC',
    );
    $q = new WP_Query($args);
    $out = '<div class="cpap_research_gallery">';
    while($q->have_posts()) {
        $q->the_post();
        $id = get_the_ID();
        $title = get_the_title();
        $thumb = get_the_post_thumbnail_url($id,'medium');
        $price = get_post_meta($id,'cpap_research_price',true);
        $link = get_post_meta($id,'cpap_research_affiliate',true);

        $out .= '<div class="cpap_research_item">';
        if ( $thumb ) {
            $out .= '<div class="thumb"><img loading="lazy" src="'.esc_url($thumb).'" alt="'.esc_attr($title).'"></div>';
        } else {
            $out .= '<div class="thumb placeholder">이미지 없음</div>';
        }
        $out .= '<h4 class="title">'.esc_html(wp_trim_words($title,12,'...')).'</h4>';
        $out .= '<div class="price">'.number_format(intval($price)).'원</div>';
        $out .= '<a class="btn" href="'.esc_url($link).'" target="_blank" rel="nofollow noopener">구매하기</a>';
        $out .= '</div>';
    }
    wp_reset_postdata();
    $out .= '</div>';

    // 쿠팡파트너스 고지문구 (옵션에 따라 표시)
    if ( get_option('cpap_research_show_disclosure',1) ) {
        $out .= '<p class="cpap_research_disclosure">본 포스팅은 쿠팡파트너스 활동의 일환으로, 이에 따른 일정액의 수수료를 제공받을 수 있습니다.</p>';
    }

    // 스타일 (간단)
    $out .= '<style>
    .cpap_research_gallery{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin:18px 0;}
    .cpap_research_item{border:1px solid #e9e9e9;padding:10px;border-radius:8px;text-align:center;background:#fff;}
    .cpap_research_item .thumb img{max-width:100%;height:auto;border-radius:6px;margin-bottom:8px;}
    .cpap_research_item .title{font-size:14px;height:44px;overflow:hidden;margin:6px 0;}
    .cpap_research_item .price{font-weight:700;margin-bottom:8px;}
    .cpap_research_item .btn{display:inline-block;padding:8px 12px;background:#ff4500;color:#fff;border-radius:6px;text-decoration:none;}
    .cpap_research_disclosure{font-size:13px;color:#555;margin-top:12px;}
    @media(max-width:1200px){.cpap_research_gallery{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:992px){.cpap_research_gallery{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:768px){.cpap_research_gallery{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:480px){.cpap_research_gallery{grid-template-columns:1fr}}
    </style>';

    return $out;
}
add_shortcode('cpap_research_gallery','cpap_research_gallery_shortcode');

/* ---- 8) 관리자 경고 (API 키 없을 때) ---- */
function cpap_research_admin_notice() {
    if ( ! current_user_can('manage_options') ) return;
    if ( empty(get_option('cpap_research_access_key')) || empty(get_option('cpap_research_secret_key')) ) {
        echo '<div class="notice notice-warning"><p>CPAP Research: 쿠팡 API 키가 설정되지 않았습니다. <a href="'.admin_url('admin.php?page=cpap-research').'">설정 페이지</a>에서 입력하세요.</p></div>';
    }
}
add_action('admin_notices','cpap_research_admin_notice');

?>
